<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Register - MRSYS</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='register.css') }}" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
</head>
<body>
  <header>
    <div class="header-content">
      <h1 class="logo">MRSYS</h1>
      <nav>
        <ul>
          <li><a href="{{ url_for('views.home') }}">Home</a></li>
          <li><a href="{{ url_for('views.about') }}">About</a></li>
          <li><a href="{{ url_for('views.benefits') }}">Benefits</a></li>
          <li><a href="{{ url_for('views.contact') }}">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="register-container">
    <h2>Register</h2>
    <form id="registrationForm">
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required>
      </div>
      <div class="form-group">
        <label for="confirm-password">Confirm Password</label>
        <input type="password" id="confirm-password" name="confirm-password" required>
      </div>

      <!-- Select Role Field -->
      <div class="form-group">
        <label for="role">Select Role</label>
        <select id="role" name="role" required>
          <option value="">Select role</option>
          <option value="individual">Individual</option>
          <option value="institution">Institution</option>
        </select>
      </div>

      <!-- Individual Fields -->
      <div id="individual-fields" style="display: none;">
        <div class="field-container">
          <div class="form-group">
            <label for="first-name">First Name</label>
            <input type="text" id="first-name" name="first-name" required>
          </div>
          <div class="form-group">
            <label for="middle-name">Middle Name</label>
            <input type="text" id="middle-name" name="middle-name">
          </div>
          <div class="form-group">
            <label for="last-name">Last Name</label>
            <input type="text" id="last-name" name="last-name" required>
          </div>
          <div class="form-group">
            <label for="gender">Gender</label>
            <select id="gender" name="gender" required>
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="dob">Date of Birth</label>
            <input type="date" id="dob" name="dob" required>
          </div>
          <div class="form-group">
            <label for="region">Region</label>
            <select id="region" name="region" required>
              <option value="">Select region</option>
            </select>
          </div>
          <div class="form-group">
            <label for="province">Province</label>
            <select id="province" name="province" required>
              <option value="">Select province</option>
            </select>
          </div>
          <div class="form-group">
            <label for="city">City/Municipality</label>
            <select id="city" name="city" required>
              <option value="">Select city</option>
            </select>
          </div>
          <div class="form-group">
            <label for="barangay">Barangay</label>
            <select id="barangay" name="barangay" required>
              <option value="">Select a barangay</option>
            </select>
          </div>
          <div class="form-group">
            <label for="street">Street Address</label>
            <input type="text" id="street" name="street" required>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="tel" id="phone" name="phone" required>
          </div>
          <div class="form-group">
            <label for="emergency-contact-name">Emergency Contact Name</label>
            <input type="text" name="individual-emergency-contact-name" id="emergency-contact-name-indiv">
          </div>
          <div class="form-group">
            <label for="emergency-contact-number">Emergency Contact Number</label>
            <input type="tel" name="individual-emergency-contact-number" id="emergency-contact-number-indiv">
          </div>
          <div class="form-group">
            <label for="individual-affiliation-type">Affiliation Type</label>
            <select id="individual-affiliation-type" name="individual-affiliation-type" required>
              <option value="">Select type</option>
              <option value="organization">Organization</option>
              <option value="school">School</option>
              <option value="none">Not Applicable</option>
            </select>
          </div>
              <!-- Organization Dropdown -->
              <div id="ind-organization-select" style="display: none;">
                <div class="form-group">
                  <label for="ind-organization-select">Select Organization</label>
                  <select id="ind-organization-select" name="ind-organization-select">
                    <option value="">Select organization</option>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="form-group">
                  <label for="ind-organization-address">Organization Address</label>
                  <input type="text" id="ind-organization-address" name="ind-organization-address" readonly>
                </div>
              </div>
              
              <!-- School Dropdown -->
              <div id="ind-school-dropdown" style="display: none;">
                <div class="form-group">
                  <label for="ind-school-select">Select School</label>
                  <select id="ind-school-select" name="ind-school-select">
                    <option value="">Select school</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="ind-school-region">Region</label>
                  <input type="text" id="ind-school-region" name="ind-school-region" readonly>
                </div>
                <div class="form-group">
                  <label for="ind-school-province">Province</label>
                  <input type="text" id="ind-school-province" name="ind-school-province" readonly>
                </div>
                <div class="form-group">
                  <label for="ind-school-city">City</label>
                  <input type="text" id="ind-school-city" name="ind-school-city" readonly>
                </div>
                <div class="form-group">
                  <label for="ind-school-type">Type</label>
                  <input type="text" id="ind-school-type" name="ind-school-type" readonly>
                </div>
              </div>
        </div>
      </div>

      <!-- Institution Fields -->
      <div id="institution-fields" style="display: none;">
        <div class="form-group">
          <label for="institution-name">Institution Name</label>
          <input type="text" id="institution-name" name="institution-name">
        </div>
        
        <div class="form-group">
          <label for="rep-last-name">Representative Last Name</label>
          <input type="text" id="rep-last-name" name="rep-last-name" required>
        </div>
        <div class="form-group">
          <label for="rep-first-name">Representative First Name</label>
          <input type="text" id="rep-first-name" name="rep-first-name" required>
        </div>
        <div class="form-group">
          <label for="rep-middle-name">Representative Middle Name</label>
          <input type="text" id="rep-middle-name" name="rep-middle-name">
        </div>
        <div class="form-group">
          <label for="rep-contact">Representative Contact Number</label>
          <input type="tel" id="rep-contact" name="rep-contact" required>
        </div>
        <div class="form-group">
          <label for="inst-region">Region</label>
          <select id="inst-region" name="inst-region" required>
            <option value="">Select region</option>
          </select>
        </div>
        <div class="form-group">
          <label for="inst-province">Province</label>
          <select id="inst-province" name="inst-province" required>
            <option value="">Select province</option>
          </select>
        </div>
        <div class="form-group">
          <label for="inst-city">City/Municipality</label>
          <select id="inst-city" name="inst-city" required>
            <option value="">Select city</option>
          </select>
        </div>
        <div class="form-group">
          <label for="inst-barangay">Barangay</label>
          <select id="inst-barangay" name="inst-barangay" required>
            <option value="">Select a barangay</option>
          </select>
        </div>
        <div class="form-group">
          <label for="inst-street">Street Address</label>
          <input type="text" id="inst-street" name="inst-street" required>
        </div>
        <div class="form-group">
          <label for="emergency-contact-name">Emergency Contact Name</label>
          <input type="text" name="institution-emergency-contact-name" id="emergency-contact-name-inst">
        </div>
        <div class="form-group">
          <label for="emergency-contact-number">Emergency Contact Number</label>
          <input type="tel" name="institution-emergencycontactnumber" id="emergency-contact-number-inst">
        </div>
        <div class="form-group">
          <label for="institutional-affiliation-type">Affiliation Type</label>
          <select id="institutional-affiliation-type" name="institutional-affiliation-type" required>
            <option value="">Select type</option>
            <option value="organization">Organization</option>
            <option value="school">School</option>
            <option value="none">Not Applicable</option>
          </select>

          <div id="ins-organization-fields" style="display: none;">
            <div class="form-group">
            <label for="ins-organization-name">Organization Name</label>
            <input type="text" id="organization-name" name="ins-organization-name">
          </div>
          <div class="form-group">
            <label for="ins-organization-address">Organization Address</label>
            <input type="text" id="ins-organization-address" name="ins-organization-address">
          </div>
        </div>
          </div>

          <div id="ins-school-fields" style="display: none;">
            <div class="form-group">
              <label for="ins-school-region">Region</label>
              <select id="ins-school-region" name="ins-school-region">
                <option value="">Select school region</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ins-school-province">Province</label>
              <select id="ins-school-province" name="ins-school-province">
                <option value="">Select school province</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ins-school-city">City/Municipality</label>
              <select id="ins-school-city" name="ins-school-city">
                <option value="">Select school city/municipality</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ins-school-name">School Name</label>
              <select id="ins-school-name" name="ins-school-name">
                <option value="">Select school name</option>
              </select>
            </div>
            <div class="form-group">
              <label for="ins-school-type">Type</label>
              <input type="text" id="ins-school-type" name="ins-school-type" readonly>
            </div>
          </div>

      </div>
      <button type="submit">Register</button>
    </form>
    <p>Already have an account? <a href="{{ url_for('auth.login') }}">Log in here</a></p>
  </main>

  <script>
    // Show/hide fields based on role selection
    document.getElementById("role").addEventListener("change", function () {
      const role = this.value;
      const individualFields = document.getElementById("individual-fields");
      const institutionFields = document.getElementById("institution-fields");
      const registerButton = document.querySelector("button[type='submit']");

      if (role === "individual") {
        individualFields.style.display = "block";
        institutionFields.style.display = "none";
        registerButton.style.display = "block"; // Ensure button is shown
      } else if (role === "institution") {
        institutionFields.style.display = "block";
        individualFields.style.display = "none";
        registerButton.style.display = "block"; // Ensure button is shown
      } else {
        individualFields.style.display = "none";
        institutionFields.style.display = "none";
        registerButton.style.display = "none"; // Hide button if no role is selected
      }
    });

    // Show/hide affiliation type fields
    document.getElementById("individual-affiliation-type").addEventListener("change", function () {
      const affiliationType = this.value;
      const organizationFields = document.getElementById("ind-organization-select");
      const schoolFields = document.getElementById("ind-school-dropdown");

      if (affiliationType === "organization") {
        organizationFields.style.display = "block";
        schoolFields.style.display = "none";
      } else if (affiliationType === "school") {
        schoolFields.style.display = "block";
        organizationFields.style.display = "none";
      } else {
        organizationFields.style.display = "none";
        schoolFields.style.display = "none";
        schoolFields.querySelectorAll('input, select').forEach(el => el.value = '');
      }
    });
    document.getElementById("institutional-affiliation-type").addEventListener("change", function () {
      const affiliationType = this.value;
      const organizationFields = document.getElementById("ins-organization-fields");
      const schoolFields = document.getElementById("ins-school-fields");

      if (affiliationType === "organization") {
        organizationFields.style.display = "block";
        schoolFields.style.display = "none";
      } else if (affiliationType === "school") {
        schoolFields.style.display = "block";
        organizationFields.style.display = "none";
      } else {
        organizationFields.style.display = "none";
        schoolFields.style.display = "none";
        schoolFields.querySelectorAll('input, select').forEach(el => el.value = '');
      }
    });

    // Dynamic dropdowns script
    document.addEventListener('DOMContentLoaded', () => {
      const regionSelect = document.getElementById('region');
      const provinceSelect = document.getElementById('province');
      const citySelect = document.getElementById('city');
      const barangaySelect = document.getElementById('barangay');

      // Fetch Regions on load
      fetch('/api/regions')
        .then(res => res.json())
        .then(data => {
          regionSelect.innerHTML = '<option value="">Select region</option>' +
            data.map(r => `<option value="${r.regionid}">${r.regionname}</option>`).join('');
        });

      regionSelect.addEventListener('change', () => {
        const regionId = regionSelect.value;
        provinceSelect.innerHTML = '<option value="">Loading...</option>';
        citySelect.innerHTML = '<option value="">Select a city</option>';
        barangaySelect.innerHTML = '<option value="">Select a barangay</option>';
        if (!regionId) {
          provinceSelect.innerHTML = '<option value="">Select a province</option>';
          return;
        }
        fetch(`/api/provinces?regionid=${regionId}`)
          .then(res => res.json())
          .then(data => {
            provinceSelect.innerHTML = '<option value="">Select a province</option>' +
              data.map(p => `<option value="${p.provinceid}">${p.provincename}</option>`).join('');
          });
      });

      provinceSelect.addEventListener('change', () => {
        const provinceId = provinceSelect.value;
        citySelect.innerHTML = '<option value="">Loading...</option>';
        barangaySelect.innerHTML = '<option value="">Select a barangay</option>';
        if (!provinceId) {
          citySelect.innerHTML = '<option value="">Select a city</option>';
          return;
        }
        fetch(`/api/cities?provinceid=${provinceId}`)
          .then(res => res.json())
          .then(data => {
            citySelect.innerHTML = '<option value="">Select a city</option>' +
              data.map(c => `<option value="${c.cityid}">${c.cityname}</option>`).join('');
          });
      });

      citySelect.addEventListener('change', () => {
        const cityId = citySelect.value;
        barangaySelect.innerHTML = '<option value="">Loading...</option>';
        if (!cityId) {
          barangaySelect.innerHTML = '<option value="">Select a barangay</option>';
          return;
        }
        fetch(`/api/barangays?cityid=${cityId}`)
          .then(res => res.json())
          .then(data => {
            barangaySelect.innerHTML = '<option value="">Select a barangay</option>' +
              data.map(b => `<option value="${b.barangayid}">${b.barangayname}</option>`).join('');
          });
      });
    });

    // School dynamic dropdowns
    document.addEventListener('DOMContentLoaded', () => {
      const roleSelect = document.getElementById("role");
      const individualFields = document.getElementById("individual-fields");
      const institutionFields = document.getElementById("institution-fields");

      const indAffiliation = document.getElementById("individual-affiliation-type");
      const indSchoolFields = document.getElementById("ind-school-fields");
      const indOrgFields = document.getElementById("ind-organization-fields");

      const insAffiliation = document.getElementById("institutional-affiliation-type");
      const insSchoolFields = document.getElementById("ins-school-fields");
      const insOrgFields = document.getElementById("ins-organization-fields");

      fetch('/api/schregions')
          .then(res => res.json())
          .then(data => {
              regionSelect.innerHTML = '<option value="">Select a school region</option>' +
                  data.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
          });

      regionSelect.addEventListener('change', () => {
          const regionId = regionSelect.value;
          provinceSelect.innerHTML = '<option value="">Loading...</option>';
          citySelect.innerHTML = '<option value="">Select a city</option>';
          schoolSelect.innerHTML = '<option value="">Select a school</option>';
          
          if (!regionId) {
              provinceSelect.innerHTML = '<option value="">Select a province</option>';
              return;
          }

          fetch(`/api/schprovinces?id=${regionId}`)
              .then(res => res.json())
              .then(data => {
                  provinceSelect.innerHTML = '<option value="">Select a province</option>' +
                      data.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
              });
      });

      provinceSelect.addEventListener('change', () => {
          const provinceId = provinceSelect.value;
          citySelect.innerHTML = '<option value="">Loading...</option>';
          schoolSelect.innerHTML = '<option value="">Select a school</option>';

          if (!provinceId) {
              citySelect.innerHTML = '<option value="">Select a city</option>';
              return;
          }

          fetch(`/api/schcities?id=${provinceId}`)
              .then(res => res.json())
              .then(data => {
                  citySelect.innerHTML = '<option value="">Select a city</option>' +
                      data.map(c => `<option value="${c.cityid}">${c.cityname}</option>`).join('');
              });
      });

      citySelect.addEventListener('change', () => {
          const cityId = citySelect.value;
          schoolSelect.innerHTML = '<option value="">Loading...</option>';

          if (!cityId) {
              schoolSelect.innerHTML = '<option value="">Select a school</option>';
              return;
          }

          fetch(`/api/schnames?id=${cityId}`)
              .then(res => res.json())
              .then(data => {
                  schoolSelect.innerHTML = '<option value="">Select a school</option>' +
                      data.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
              });
      });
    });

    // Fetch school names based on selected city
    async function fetchSchoolNames(cityId) {
      const response = await fetch(`/api/schnames?cityid=${cityId}`);
      if (!response.ok) {
        const error = await response.json();
        console.error('Error fetching school names:', error);
        return [];
      }
      return await response.json();
    }

    // Example usage when a city is selected
    document.getElementById("ins-city-select").addEventListener("change", async function () {
      const cityId = this.value;
      const schoolSelect = document.getElementById("ins-school-select");
      schoolSelect.innerHTML = '<option value="">Loading...</option>'; // Show loading state

      if (cityId) {
        const schoolNames = await fetchSchoolNames(cityId);
        schoolSelect.innerHTML = '<option value="">Select school</option>'; // Reset options

        schoolNames.forEach(school => {
          const option = document.createElement('option');
          option.value = school.id; // Assuming 'id' is the primary key in schname
          option.textContent = school.name; // Assuming 'name' is the field for school name
          schoolSelect.appendChild(option);
        });
      } else {
        schoolSelect.innerHTML = '<option value="">Select school</option>'; // Reset if no city selected
      }
    });

  </script>

  <script src="{{ url_for('static', filename='register_individual.js') }}" defer></script>
  <script src="{{ url_for('static', filename='register_institution.js') }}" defer></script>
  <script src="{{ url_for('static', filename='register_save.js') }}" defer></script>
  <script src="{{ url_for('static', filename='register_data_validation.js') }}" defer></script>
  <script src="{{ url_for('static', filename='register_school.js') }}" defer></script>

  <script>
  document.getElementById("registrationForm").addEventListener("submit", function (e) {
    e.preventDefault(); // prevent default form submission

    const affiliationType = document.getElementById("individual-affiliation-type").value;

    // Optional: you can do validation or save to server here before redirecting

    if (affiliationType === "none") {
      window.location.href = "{{ url_for('views.billingpayment') }}"; //PALITAN NG REGISTRATION PAYMENT
    } else if (affiliationType === "organization" || affiliationType === "school") {
      window.location.href = "{{ url_for('views.userdashboard') }}";
    } else {
      alert("Please select an affiliation type.");
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    const roleSelect = document.getElementById("role");
    const affTypeSelect = document.getElementById("institutional-affiliation-type");

    const schoolFields = document.getElementById("ins-school-fields");
    const orgFields = document.getElementById("ins-organization-fields");

    function updateInstitutionFields() {
      const role = roleSelect.value;
      const type = affTypeSelect.value;

      if (role === "institution" && type === "school") {
        schoolFields.style.display = "block";
        orgFields.style.display = "none";
      } else if (role === "institution" && type === "organization") {
        orgFields.style.display = "block";
        schoolFields.style.display = "none";
      } else {
        orgFields.style.display = "none";
        schoolFields.style.display = "none";
      }
    }

    roleSelect.addEventListener("change", updateInstitutionFields);
    affTypeSelect.addEventListener("change", updateInstitutionFields);

    const orgSelect = document.getElementById("ind-organization-select");
    const orgAddress = document.getElementById("ind-organization-address");

    fetch("/api/organizations")
      .then(res => res.json())
      .then(data => {
        orgSelect.innerHTML = '<option value="">Select organization</option>' +
          data.map(org => `<option value="${org.id}" data-address="${org.address}">${org.name}</option>`).join('');
      });

    // Autofill address when organization is selected
    orgSelect.addEventListener("change", function () {
      const selected = this.options[this.selectedIndex];
      orgAddress.value = selected.dataset.address || "";
    });

  });
</script>

</body>
</html>
